+++
title = "Sync/Async Logging"
date = "2022-08-14"
tags = ["logging"]
+++


## Понятие logging
В этой заметке log - текст, который передается в стандартные потоки вывода процесса: `stdout/stderr`
Запись может быть fromat-ированной и в виде `json` (мета). 
В микросервисном мире мы скейлим наше приложение горизонтально, и так как трудно попасть на все поды разом, log-и используются как инструмент обратной связи от кода.

## Async logging?
Запись в `stdout` == блокирующая запись в `fd`, то есть в буффер на стороне Kernel-а.
Поэтому есть библиотеки, которые позволяют писать логи без блокировки. То есть между вызовом метода `log` и попаданием текста в `std*` есть программный буффер, 
который лишь раз в `х` секунд флашится (flush=запись + очистка) в `std*`. Это уменьшает latancy из-за более редкого вызова [sys-call-а](https://man7.org/linux/man-pages/man2/write.2.html). 

Программный буффер дает ещё одно преимущество: семплировать логи по ключам. То есть отбрасывать похожие логи, для того чтобы не записывать одинаковые строки.
В буфере это сделать проще, хотя можно это делать и в обычном потоковом логгировании.



## Зачем нужен logging?
Для того чтобы понять возможность использования подобных библиотек, вернемся к тому для чего используются логи:
- для дебага или возможности отложенного дебага. Для этого нам важно построить трейс того, что происходило в коде до ошибки и залогировать саму ошибку.
Но если при этом происходит краш, то при использовании асинхронных логов буффер логов не флешнется, потому что код уже упал.
Получаем ситуацию, в которой проблема прозошла, а логов о проблеме нет. Поэтому дебаг-логи и ошибки должны быть синхронным, как пример деволтные настройки `sentry`;
- для проверки факта запуска или результатов запуска. То есть: посмотреть пользуются ли HTTP-handler-ом и какие параметры передают.
Или отработала ли cron-джоба. Здесь логер мог бы быть асинхронным.
Но такие логи можно заменить на что-то другое. Гораздо больше для этой задачи подходят метрики.
Логер будет подходить, только если нужны параметры. Здесь выбор сводится к необходимой точности: можем ли мы потерять часть параметров или их точность;
- как мусорка. Это самое частое, что я вижу при использовании логов. В этом сценарии не ясно зачем вообще что-то логировать.

## Итого
Там где логи нужны, нам важна синхронность записи, чтобы эти записи не потерять. Но если вы их используете в качестве замены метрикам, то асинхронный логер вам подойдет.
