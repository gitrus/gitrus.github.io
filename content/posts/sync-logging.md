+++
title = "Sync/Async Logging"
date = "2022-08-14"
tags = ["logging"]
+++


## Понятие logging
В этой заметке log - текст, который передается в стандартные потоки вывода процесса: `stdout/stderr`
Запись может быть fromat-ированной и в виде `json` (мета). 
В микросервисном мире с kubernetes, из-за невозможности попасть на все поды разом, log-и используются как инструмент общения с кодом.

## Async logging?
Запись в `stdout` == блокирующая запись в `pipe`, то есть в буффер на стороне Kernel-а.
Поэтому есть библиотеки, которые позволяют писать логи без блокировки. То есть между вызовом метода `log` и попаданием текста в `std*` есть программный буффер, 
который лишь раз в `х` секунд флашится (flush=запись + очистка) в `std*`. Это уменьшает latancy из-за более редкого вызова sys-call-а. 

Буффер дает пойти ещё дальше: семплировать логи по ключам. То есть отбрасывать похожие логи, для того чтобы не записывать одинаковые строки.



## Зачем нужен logging?
Для того, чтобы понять возможность использования подобных библиотек, вернемся к тому для чего используются логи:
- для дебага или отложенного дебага. Для этого нам важно построить трейс того, что происходило в коде до ошибки и залогировать саму ошибку.
Но если при этом происходит краш, то при использовании асинхронных логов буффер логов не флешнется, потому что код уже упал.
Получаем ситуацию, в которой проблема прозошла, а логов о проблеме нет. Поэтому дебаг-логи и ошибки должны быть синхронным, как пример `sentry`
- для проверки факта запуска или результатов запуска. То есть: посмотреть пользуются ли ручкой и какие параметры передают. Или отработала ли cron-джоба. Здесь логер мог бы быть асинхронным.
Но с другой стороны зачем здесь логер? Кажется, гораздо больше для этой задачи подходят метрики.
Логер будет подходить, только если нужны параметры. Здесь выбор сводится к необходимой точности: можем ли мы потерять часть параметров или семплировать их.
- как мусорка. Это самое частое использование логов. В этом сценарии не ясно зачем вообще что-то логировать.

## Итого
Там где логи нужны, там часто важна синхронность записи, чтобы эти записи не потерять. А там где нет -- в целом без разницы.
